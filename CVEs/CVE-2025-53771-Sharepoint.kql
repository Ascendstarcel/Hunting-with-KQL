// Encoded PowerShell and suspicious IIS worker activity related to Microsoft zero-day for Sharepoint
DeviceProcessEvents
| where TimeGenerated > ago(30d)
| where ProcessCommandLine has_any ("-enc", "EncodedCommand") or InitiatingProcessFileName has "w3wp.exe"
| where AdditionalFields has_any ("CVE-2025-53770", "CVE-2025-53771", "CVE-2025-49706", "CVE-2025-49704")
| summarize count() by DeviceId, InitiatingProcessFileName, ProcessCommandLine
| where count_ > 3

// Web shell file creation linked to SharePoint zero-day
DeviceFileEvents
| where TimeGenerated > ago(30d)
| where FileName has_any ("spinstall0.aspx", "shell.aspx")
| where FolderPath has_any (@'Microsoft Shared\Web Server Extensions\', @'inetpub\wwwroot')
| extend CVE = "CVE-2025-53770/CVE-2025-53771"
| project Timestamp, DeviceName, FileName, FolderPath, CVE

// Advanced hunting from microsoft advisory
// https://www.microsoft.com/en-us/msrc/blog/2025/07/customer-guidance-for-sharepoint-vulnerability-cve-2025-53770
DeviceProcessEvents
| where InitiatingProcessFileName has "w3wp.exe"
 and InitiatingProcessCommandLine !has "DefaultAppPool"
 and FileName =~ "cmd.exe"
 and ProcessCommandLine has_all ("cmd.exe", "powershell")
 and ProcessCommandLine has_any ("EncodedCommand", "-ec")
| extend CommandArguments = split(ProcessCommandLine, " ")
| mv-expand CommandArguments to typeof(string)
| where CommandArguments matches regex "^[A-Za-z0-9+/=]{15,}$"
| extend B64Decode = replace("\\x00", "", base64_decodestring(tostring(CommandArguments)))  
| where B64Decode has_any ("spinstall0", @'C:\PROGRA~1\COMMON~1\MICROS~1\WEBSER~1\15\TEMPLATE\LAYOUTS', @'C:\PROGRA~1\COMMON~1\MICROS~1\WEBSER~1\16\TEMPLATE\LAYOUTS')
